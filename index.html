<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generator Cost Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
  :root {
    --bg: #f9f9f9;
    --text: #333;
    --table-bg: #eee;
  }
  body.dark {
    --bg: #1e1e1e;
    --text: #f0f0f0;
    --table-bg: #333;
  }
  body {
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 0 1rem 2rem;
    transition: background 0.3s, color 0.3s;
  }
  h1 {
    text-align: center;
    margin: 1rem 0;
  }
  .summary-row {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	gap: 30px;
	margin: 1rem 0;
  }

  .summary-item {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 10px;
	font-weight: bold;
	}

  .summary-item label {
	min-width: 160px;
	text-align: right;
	}

  .summary-item input {
	width: 80px;
	padding: 6px;
	font-size: 1rem;
	}
  .controls {
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 1000;
    padding: 10px 0;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    border-bottom: 1px solid #ccc;
  }
  .inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin: 1rem 0;
  }
  .inputs label {
    display: flex;
    flex-direction: column;
    font-weight: bold;
    min-width: 140px;
  }
  input[type="number"] {
    width: 40%;
    padding: 10px;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  button {
    padding: 10px 16px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    border: none;
    border-radius: 4px;
    background-color: #0078d4;
    color: white;
  }
  button:hover {
    background-color: #005fa3;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 0.95rem;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 10px 6px;
    text-align: center;
  }
  th {
    background: var(--table-bg);
  }
  canvas {
    margin-top: 40px;
    max-width: 100%;
  }

  /* Responsive tweaks */
  @media (max-width: 768px) {
    .inputs {
      flex-direction: column;
      align-items: stretch;
    }
    .inputs label {
      width: 100%;
    }
    .controls {
      flex-direction: column;
      align-items: center;
    }
    button {
      width: 100%;
      max-width: 300px;
    }
  }
  
  @media print {
  /* Hide all input boxes */
  input[type="number"] {
    border: none !important;
    background: transparent !important;
    color: black !important;
    -webkit-appearance: none;
    appearance: none;
  }

  /* Replace inputs with their values */
  input[type="number"]::before {
    content: attr(value);
    color: black;
    font-size: 1rem;
  }

  /* Hide the actual typed text so only the printed value shows */
  input[type="number"] {
    color: transparent !important;
  }

  /* Hide controls bar */
  .controls {
    display: none !important;
  }
}
</style>
</head>
<body>
  <h1>Generator Cost Calculator</h1>

  <div class="controls">
  <button onclick="getAvgPrice()">‚õΩ Get Avg. Price</button>
  <button onclick="toggleTheme()">üåì Toggle Theme</button>
  <button onclick="savePreset()">üíæ Save Preset</button>
  <button onclick="loadPreset()">üìÇ Load Preset</button>
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(event)">
  <button onclick="document.getElementById('csvInput').click()">üì• Import CSV</button>
  <button onclick="exportCSV()">üì§ Export CSV</button>
  <button onclick="printSummary()">üñ®Ô∏è Print Summary (PDF)</button>
  </div>

  <div class="inputs summary-row">
  <div class="summary-item">
    <label for="dieselPrice">Diesel Price (AUD/L)</label>
    <input type="number" id="dieselPrice" value="1.844" step="0.001" />
  </div>
  <div class="summary-item">
    <label for="tankSize">Tank Size (L)</label>
    <input type="number" id="tankSize" value="125" />
  </div>
  <div class="summary-item">
    <label for="runtime">Runtime per Tank (hrs)</label>
    <input type="number" id="runtime" value="20" />
  </div>
  <div class="summary-item">
    <label for="kva">Generator Output (kVA)</label>
    <input type="number" id="kva" value="18" />
  </div>
</div>

  <table>
    <thead>
      <tr>
        <th>Month</th>
        <th>Outage Hours</th>
        <th>Diesel Used (L)</th>
        <th>Cost (AUD)</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
    <tfoot>
      <tr>
        <th>Total</th>
        <th id="totalHours">0</th>
        <th id="totalDiesel">0</th>
        <th id="totalCost">0</th>
      </tr>
    </tfoot>
  </table>

  <canvas id="costChart" height="100"></canvas>

  <script>
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const tableBody = document.getElementById("tableBody");

    months.forEach((month, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${month}</td>
        <td><input type="number" class="hours" value="0" /></td>
        <td class="dieselUsed">0</td>
        <td class="cost">0</td>
      `;
      tableBody.appendChild(row);
    });

    const update = () => {
      const dieselPrice = parseFloat(document.getElementById("dieselPrice").value);
      const tankSize = parseFloat(document.getElementById("tankSize").value);
      const runtime = parseFloat(document.getElementById("runtime").value);

      let totalHours = 0, totalDiesel = 0, totalCost = 0;
      const hoursInputs = document.querySelectorAll(".hours");
      const dieselCells = document.querySelectorAll(".dieselUsed");
      const costCells = document.querySelectorAll(".cost");

      const chartHours = [];
      const chartCosts = [];

      hoursInputs.forEach((input, i) => {
        const hours = parseFloat(input.value) || 0;
        const dieselUsed = (hours / runtime) * tankSize;
        const cost = dieselUsed * dieselPrice;

        dieselCells[i].textContent = dieselUsed.toFixed(2);
        costCells[i].textContent = cost.toFixed(2);

        totalHours += hours;
        totalDiesel += dieselUsed;
        totalCost += cost;

        chartHours.push(hours);
        chartCosts.push(cost);
      });

      document.getElementById("totalHours").textContent = totalHours.toFixed(1);
      document.getElementById("totalDiesel").textContent = totalDiesel.toFixed(1);
      document.getElementById("totalCost").textContent = totalCost.toFixed(2);

      updateChart(chartHours, chartCosts);
    };

    document.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", update);
    });

    let chart;
    const ctx = document.getElementById("costChart").getContext("2d");

    function updateChart(hours, costs) {
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: months,
          datasets: [
            {
              label: "Outage Hours",
              data: hours,
              backgroundColor: "rgba(54, 162, 235, 0.6)"
            },
            {
              label: "Cost (AUD)",
              data: costs,
              backgroundColor: "rgba(255, 159, 64, 0.6)"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    function savePreset() {
      const preset = {
        dieselPrice: document.getElementById("dieselPrice").value,
        tankSize: document.getElementById("tankSize").value,
        runtime: document.getElementById("runtime").value,
        kva: document.getElementById("kva").value,
        hours: Array.from(document.querySelectorAll(".hours")).map(i => i.value)
      };
      localStorage.setItem("generatorPreset", JSON.stringify(preset));
      alert("Preset saved!");
    }

    function loadPreset() {
      const preset = JSON.parse(localStorage.getItem("generatorPreset"));
      if (!preset) return alert("No preset found.");
      document.getElementById("dieselPrice").value = preset.dieselPrice;
      document.getElementById("tankSize").value = preset.tankSize;
      document.getElementById("runtime").value = preset.runtime;
      document.getElementById("kva").value = preset.kva;
      document.querySelectorAll(".hours").forEach((input, i) => {
        input.value = preset.hours[i] || 0;
      });
      update();
    }

        function exportCSV() {
  // Default filename
  let defaultName = "generator_costs.csv";

  // Ask user if they want to overwrite
  const overwrite = confirm("Do you want to overwrite the existing CSV file name?");

  let fileName = defaultName;

  if (!overwrite) {
    // Ask for a new name
    const newName = prompt("Enter a new file name (without extension):", "generator_costs_updated");
    if (newName && newName.trim() !== "") {
      fileName = newName.trim() + ".csv";
    }
  }

  // Build CSV content
  let csv = "Month,Outage Hours,Diesel Used (L),Cost (AUD)\n";
  const rows = document.querySelectorAll("#tableBody tr");

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    const month = cells[0].textContent;
    const hours = cells[1].querySelector("input").value;
    const diesel = cells[2].textContent;
    const cost = cells[3].textContent;
    csv += `${month},${hours},${diesel},${cost}\n`;
  });

  // Create file and trigger download
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
	
	function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split("\n").map(line => line.trim()).filter(line => line);
    if (lines.length < 2) return alert("CSV is empty or invalid.");

    const header = lines[0].split(",");
    const rows = lines.slice(1);

    rows.forEach((line, i) => {
      const [month, hours, diesel, cost] = line.split(",");
      const input = document.querySelectorAll(".hours")[i];
      if (input) input.value = hours;
    });

    update();
    alert("CSV imported successfully!");
  };
  reader.readAsText(file);
}
	
	function getAvgPrice() {
  const url = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://www.fuelwatch.wa.gov.au/fuelwatch/fuelWatchRSS?Product=2&Suburb=Gidgegannup");

  fetch(url)
    .then(response => response.text())
    .then(str => {
      const parser = new DOMParser();
      const xml = parser.parseFromString(str, "application/xml");
      const items = xml.querySelectorAll("item");
      const prices = [];

      items.forEach(item => {
        const priceText = item.querySelector("price").textContent;
        const priceCents = parseFloat(priceText);
        if (!isNaN(priceCents)) prices.push(priceCents / 100); // Convert to dollars
      });

      if (prices.length > 0) {
        const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
        document.getElementById("dieselPrice").value = avg.toFixed(3);
        update();
        alert(`Average diesel price from ${prices.length} stations: $${avg.toFixed(3)} per litre`);
      } else {
        alert("No diesel prices found for Gidgegannup.");
      }
    })
    .catch(err => {
      console.error("Failed to fetch diesel prices:", err);
      alert("Could not fetch diesel prices. Please try again later.");
      });
	}
	
	function printSummary() {
	// Clone inputs into static text for printing
	const inputs = document.querySelectorAll("input[type='number']");
	inputs.forEach(input => {
		const span = document.createElement("span");
		span.textContent = input.value;
		span.className = "print-value";
		span.style.fontWeight = "bold";
		span.style.padding = "6px";
		span.style.display = "inline-block";
		span.style.minWidth = input.offsetWidth + "px";
		span.style.textAlign = "center";
		input.style.display = "none";
		input.parentNode.appendChild(span);
	});

	// Hide controls bar
	const controls = document.querySelector(".controls");
	controls.style.display = "none";

	// Trigger print
	setTimeout(() => {
		window.print();

	// Restore inputs after print
    inputs.forEach(input => {
      input.style.display = "";
      const span = input.parentNode.querySelector(".print-value");
      if (span) span.remove();
    });
    controls.style.display = "flex";
		}, 100);
	}

    // Load theme preference on page load
    window.onload = () => {
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
      }
      update();
    };
  </script>
</body>
</html>
